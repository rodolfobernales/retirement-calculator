<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Financiero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .dark .card {
             background-color: #1f2937; /* gray-800 */
             border: 1px solid #374151; /* gray-700 */
        }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4b5563; }
        .dark .input-label { color: #d1d5db; /* gray-300 */ }
        .input-field {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .input-field {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
        .input-field:focus {
            outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .dark .input-field:focus {
             border-color: #818cf8; /* indigo-400 */
             box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
        }
        .slider {
            -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d1d5db;
            outline: none; opacity: 0.7; transition: opacity .2s;
        }
        .dark .slider { background: #4b5563; }
        .slider:hover { opacity: 1; }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: #6366f1; cursor: pointer;
        }
        .dark .slider::-webkit-slider-thumb { background: #818cf8; }
        .slider::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: #6366f1; cursor: pointer;
        }
        .dark .slider::-moz-range-thumb { background: #818cf8; }
        .result-value { font-size: 2.25rem; font-weight: 700; color: #6366f1; }
        .dark .result-value { color: #818cf8; }
        .tab-button, .lang-button {
            padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease;
        }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button.inactive { background-color: #e0e7ff; color: #4338ca; }
        .dark .tab-button.active { background-color: #6366f1; }
        .dark .tab-button.inactive { background-color: #3730a3; color: #c7d2fe; }
        .lang-button.active { background-color: #059669; color: white; }
        .lang-button.inactive { background-color: #a7f3d0; color: #047857; }
        .dark .lang-button.active { background-color: #10b981; }
        .dark .lang-button.inactive { background-color: #064e3b; color: #a7f3d0; }
        .currency-button {
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 500; font-size: 0.875rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        .currency-button.active { background-color: #10b981; color: white; }
        .currency-button.inactive { background-color: #d1fae5; color: #047857; }
        .dark .currency-button.active { background-color: #10b981; }
        .dark .currency-button.inactive { background-color: #065f46; color: #a7f3d0; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-300">

    <main class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-10 md:mb-16 relative">
             <div id="header-controls" class="absolute top-0 right-4 flex items-center space-x-2">
                <div class="flex space-x-2 bg-green-100 dark:bg-gray-800 p-1 rounded-full">
                    <button id="es-btn" data-lang="es" class="lang-button active text-sm">ES</button>
                    <button id="en-btn" data-lang="en" class="lang-button inactive text-sm">EN</button>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 11-1.414-1.414l-.707.707a1 1 0 010 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <h1 data-translate="mainTitle" class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-gray-100">Planificador Financiero</h1>
            <p data-translate="mainSubtitle" class="mt-4 text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">Calcula tu plan de jubilaci칩n o define una meta de ahorro.</p>
            
            <div class="mt-6 flex justify-center space-x-2 bg-indigo-100 dark:bg-gray-800 p-1 rounded-full w-max mx-auto">
                <button id="retirement-tab" data-translate="retirementTab" class="tab-button active">Plan de Jubilaci칩n</button>
                <button id="savings-tab" data-translate="savingsTab" class="tab-button inactive">Meta de Ahorro</button>
            </div>
            
            <div id="currency-selector" class="mt-4 flex justify-center space-x-2 bg-green-100 dark:bg-gray-800 p-1 rounded-full w-max mx-auto">
                <button data-currency="CLP" class="currency-button active">CLP 游뻟릖</button>
                <button data-currency="USD" class="currency-button inactive">USD 游쥟릖</button>
                <button data-currency="MXN" class="currency-button inactive">MXN 游쓇릖</button>
            </div>
        </header>

        <div id="content-area">
            <div id="retirement-calculator">
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2">
                        <div class="card p-6 md:p-8 sticky top-8">
                            <h2 data-translate="retirementDetailsTitle" class="text-2xl font-semibold mb-6">Tus Detalles de Jubilaci칩n</h2>
                            <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="currentAge" data-translate="currentAge" class="input-label">Edad Actual</label>
                                    <span id="currentAgeValue" class="font-semibold text-indigo-600 dark:text-indigo-400">30</span>
                                </div>
                                <input type="range" id="currentAge" class="slider" min="18" max="70" value="30">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="retirementAge" data-translate="retirementAge" class="input-label">Edad de Jubilaci칩n</label>
                                    <span id="retirementAgeValue" class="font-semibold text-indigo-600 dark:text-indigo-400">65</span>
                                </div>
                                <input type="range" id="retirementAge" class="slider" min="50" max="84" value="65">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="interestRate" data-translate="interestRate" class="input-label">Tasa de Inter칠s Anual (%)</label>
                                    <span id="interestRateValue" class="font-semibold text-indigo-600 dark:text-indigo-400">10.0</span>
                                </div>
                                <input type="range" id="interestRate" class="slider" min="1" max="15" step="0.1" value="10">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="inflationRate" data-translate="inflationRate" class="input-label">Inflaci칩n Anual (%)</label>
                                    <span id="inflationRateValue" class="font-semibold text-indigo-600 dark:text-indigo-400">4.0</span>
                                </div>
                                <input type="range" id="inflationRate" class="slider" min="0" max="10" step="0.1" value="4">
                            </div>
                            <div class="input-group">
                                <label for="initialSavings" class="input-label"><span data-translate="initialSavings">Ahorro Inicial</span> (<span class="currency-label">CLP</span>)</label>
                                <input type="text" id="initialSavings" inputmode="numeric" class="input-field" value="0">
                            </div>
                            <div class="input-group">
                                <label for="monthlyPensionInput" class="input-label"><span data-translate="monthlyPension">Pensi칩n Mensual Deseada</span> (<span class="currency-label">CLP</span> <span data-translate="today">de hoy</span>)</label>
                                <input type="text" id="monthlyPensionInput" inputmode="numeric" class="input-field" value="1.000.000">
                                <p id="pensionFutureValueNote" class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-left h-4"></p>
                            </div>
                            <p id="retirement-error-message" class="text-red-500 text-sm h-4"></p>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                        <div class="card p-6 md:p-8">
                            <h2 data-translate="estimatedSavingsPlan" class="text-2xl font-semibold mb-6">Tu Plan de Ahorro Estimado</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 text-center">
                                <div class="bg-indigo-50 dark:bg-gray-700 p-6 rounded-lg">
                                    <h3 data-translate="monthlySavingRequired" class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-2">Ahorro Mensual Requerido</h3>
                                    <p id="monthlySaving" class="result-value">$0</p>
                                </div>
                                <div class="bg-indigo-50 dark:bg-gray-700 p-6 rounded-lg">
                                    <h3 data-translate="annualSavingRequired" class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-2">Ahorro Anual Requerido</h3>
                                    <p id="annualSaving" class="result-value">$0</p>
                                </div>
                            </div>
                            <div class="mt-8">
                                <h3 data-translate="projectedGrowth" class="text-xl font-semibold mb-4 text-center">Crecimiento Proyectado</h3>
                                <div class="relative h-80 md:h-96">
                                    <canvas id="retirementChart"></canvas>
                                </div>
                            </div>
                            <div id="retirement-summary" class="mt-8 text-center bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="savings-calculator" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2">
                        <div class="card p-6 md:p-8 sticky top-8">
                            <h2 data-translate="yourSavingsGoal" class="text-2xl font-semibold mb-6">Tu Meta de Ahorro</h2>
                            <div class="input-group">
                                <label for="goalName" data-translate="goalName" class="input-label">Nombre de tu meta</label>
                                <input type="text" id="goalName" class="input-field">
                            </div>
                            <div class="input-group">
                                <label for="goalAmount" class="input-label"><span data-translate="goalAmount">Monto de la Meta</span> (<span class="currency-label-goal">CLP</span>)</label>
                                <input type="text" id="goalAmount" inputmode="numeric" class="input-field">
                            </div>
                             <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="goalInterestRate" data-translate="goalInterestRate" class="input-label">Tasa de Inter칠s Anual (%)</label>
                                    <span id="goalInterestRateValue" class="font-semibold text-indigo-600 dark:text-indigo-400">5.0</span>
                                </div>
                                <input type="range" id="goalInterestRate" class="slider" min="0" max="15" step="0.1" value="5">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center">
                                    <label for="goalYears" data-translate="goalYears" class="input-label">쮼n cu치ntos a침os?</label>
                                    <span id="goalYearsValue" class="font-semibold text-indigo-600 dark:text-indigo-400">2</span>
                                </div>
                                <input type="range" id="goalYears" class="slider" min="1" max="20" value="2">
                            </div>
                             <p id="savings-error-message" class="text-red-500 text-sm h-4"></p>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                         <div class="card p-6 md:p-8 text-center">
                            <h2 id="savings-result-title" data-translate="yourSavingsPlan" class="text-2xl font-semibold mb-6">Tu Plan de Ahorro</h2>
                             <div class="bg-indigo-50 dark:bg-gray-700 p-8 rounded-lg">
                                <h3 data-translate="monthlySavingRequired" class="text-xl font-medium text-gray-600 dark:text-gray-300 mb-2">Ahorro Mensual Necesario</h3>
                                <p id="monthlySavingsGoal" class="text-5xl font-bold text-indigo-600 dark:text-indigo-400">$0</p>
                            </div>
                             <div class="mt-8">
                                <h3 data-translate="savingsProgress" class="text-xl font-semibold mb-4 text-center">Progreso de Ahorro</h3>
                                <div class="relative h-80 md:h-96">
                                    <canvas id="savingsChart"></canvas>
                                </div>
                            </div>
                             <div id="savings-summary" class="mt-8 text-center bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full py-6">
        <div class="container mx-auto text-center text-gray-600 dark:text-gray-400">
            <p><span data-translate="developedBy">Desarrollado por</span> 
                <span class="font-semibold text-indigo-600">Rolox</span>
            </p>
        </div>
    </footer>

    <script>
        // --- Constants and Global Vars ---
        const LIFE_EXPECTANCY = 85;
        let retirementChart, savingsChart;
        let currentCurrency = 'CLP';
        let currentLang = 'es';

        const currencySettings = {
            CLP: { locale: 'es-CL', defaultPension: '1000000', defaultInitial: '0', defaultGoal: '5000000' },
            USD: { locale: 'en-US', defaultPension: '4000', defaultInitial: '0', defaultGoal: '20000' },
            MXN: { locale: 'es-MX', defaultPension: '50000', defaultInitial: '0', defaultGoal: '300000' }
        };
        
        const translations = {
            es: {
                mainTitle: "Planificador Financiero", mainSubtitle: "Calcula tu plan de jubilaci칩n o define una meta de ahorro.",
                retirementTab: "Plan de Jubilaci칩n", savingsTab: "Meta de Ahorro",
                retirementDetailsTitle: "Tus Detalles de Jubilaci칩n", currentAge: "Edad Actual", retirementAge: "Edad de Jubilaci칩n",
                interestRate: "Tasa de Inter칠s Anual (%)", inflationRate: "Inflaci칩n Anual (%)",
                initialSavings: "Ahorro Inicial", monthlyPension: "Pensi칩n Mensual Deseada", today: "de hoy",
                estimatedSavingsPlan: "Tu Plan de Ahorro Estimado", monthlySavingRequired: "Ahorro Mensual Requerido",
                annualSavingRequired: "Ahorro Anual Requerido", projectedGrowth: "Crecimiento Proyectado",
                retirementSummary1: "Para financiar tu pensi칩n hasta los", retirementSummary2: "a침os, necesitas acumular un fondo total de",
                retirementSummary3: "De ese fondo,", retirementSummary4: "ser치n tus contribuciones y", retirementSummary5: "ser치n intereses ganados.",
                pensionFutureNote: "Ser치 equivalente a", pensionFutureNote2: "al momento de jubilarte.",
                errorRetirementAge: "La edad de jubilaci칩n debe ser mayor a la actual y menor a 85.",
                yourSavingsGoal: "Tu Meta de Ahorro", goalName: "Nombre de tu meta", goalAmount: "Monto de la Meta",
                goalInterestRate: "Tasa de Inter칠s Anual (%)", goalYears: "쮼n cu치ntos a침os?", yourSavingsPlan: "Tu Plan de Ahorro",
                savingsProgress: "Progreso de Ahorro", errorGoalAmount: "Ingresa un monto v치lido para tu meta.",
                savingsSummary1: "Al final del plazo, habr치s aportado", savingsSummary2: "y ganado",
                savingsSummary3: "en intereses, para alcanzar tu meta de", savingsPlanFor: "Plan para",
                developedBy: "Desarrollado por", chartTotalContributions: "Aportes Totales", chartInterestEarned: "Intereses Ganados",
                chartYear: "A침o", chartValue: "Valor", chartSavingsAccumulated: "Ahorro Acumulado"
            },
            en: {
                mainTitle: "Financial Planner", mainSubtitle: "Calculate your retirement plan or set a savings goal.",
                retirementTab: "Retirement Plan", savingsTab: "Savings Goal",
                retirementDetailsTitle: "Your Retirement Details", currentAge: "Current Age", retirementAge: "Retirement Age",
                interestRate: "Annual Interest Rate (%)", inflationRate: "Annual Inflation (%)",
                initialSavings: "Initial Savings", monthlyPension: "Desired Monthly Pension", today: "today",
                estimatedSavingsPlan: "Your Estimated Savings Plan", monthlySavingRequired: "Required Monthly Savings",
                annualSavingRequired: "Required Annual Savings", projectedGrowth: "Projected Growth",
                retirementSummary1: "To fund your pension until age", retirementSummary2: ", you need to accumulate a total fund of",
                retirementSummary3: "Of that fund,", retirementSummary4: "will be your contributions and", retirementSummary5: "will be interest earned.",
                pensionFutureNote: "It will be equivalent to", pensionFutureNote2: "at the time of retirement.",
                errorRetirementAge: "Retirement age must be greater than current age and less than 85.",
                yourSavingsGoal: "Your Savings Goal", goalName: "Goal name", goalAmount: "Goal Amount",
                goalInterestRate: "Annual Interest Rate (%)", goalYears: "In how many years?", yourSavingsPlan: "Your Savings Plan",
                savingsProgress: "Savings Progress", errorGoalAmount: "Please enter a valid amount for your goal.",
                savingsSummary1: "At the end of the term, you will have contributed", savingsSummary2: "and earned",
                savingsSummary3: "in interest, to reach your goal of", savingsPlanFor: "Plan for",
                developedBy: "Developed by", chartTotalContributions: "Total Contributions", chartInterestEarned: "Interest Earned",
                chartYear: "Year", chartValue: "Value", chartSavingsAccumulated: "Accumulated Savings"
            }
        };

        // --- DOM Elements (Declare with let) ---
        let themeToggleBtn, themeToggleDarkIcon, themeToggleLightIcon, retirementTab, savingsTab,
            retirementCalculatorDiv, savingsCalculatorDiv, currencySelectorDiv, headerControlsDiv,
            currentAgeInput, retirementAgeInput, interestRateInput, inflationRateInput,
            initialSavingsInput, monthlyPensionInput, currentAgeValue, retirementAgeValue,
            interestRateValue, inflationRateValue, pensionFutureValueNoteEl, monthlySavingEl,
            annualSavingEl, retirementSummaryDiv, retirementErrorMessageEl, retirementChartCtx,
            goalNameInput, goalAmountInput, goalYearsInput, goalInterestRateInput,
            goalInterestRateValue, goalYearsValue, monthlySavingsGoalEl, savingsResultTitleEl,
            savingsErrorMessageEl, savingsChartCtx, savingsSummaryDiv;

        // --- Assign DOM Elements after DOM is loaded ---
        function assignDOMElements() {
            themeToggleBtn = document.getElementById('theme-toggle');
            themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
            retirementTab = document.getElementById('retirement-tab');
            savingsTab = document.getElementById('savings-tab');
            retirementCalculatorDiv = document.getElementById('retirement-calculator');
            savingsCalculatorDiv = document.getElementById('savings-calculator');
            currencySelectorDiv = document.getElementById('currency-selector');
            headerControlsDiv = document.getElementById('header-controls');
            
            // Retirement Elements
            currentAgeInput = document.getElementById('currentAge');
            retirementAgeInput = document.getElementById('retirementAge');
            interestRateInput = document.getElementById('interestRate');
            inflationRateInput = document.getElementById('inflationRate');
            initialSavingsInput = document.getElementById('initialSavings');
            monthlyPensionInput = document.getElementById('monthlyPensionInput');
            currentAgeValue = document.getElementById('currentAgeValue');
            retirementAgeValue = document.getElementById('retirementAgeValue');
            interestRateValue = document.getElementById('interestRateValue');
            inflationRateValue = document.getElementById('inflationRateValue');
            pensionFutureValueNoteEl = document.getElementById('pensionFutureValueNote');
            monthlySavingEl = document.getElementById('monthlySaving');
            annualSavingEl = document.getElementById('annualSaving');
            retirementSummaryDiv = document.getElementById('retirement-summary');
            retirementErrorMessageEl = document.getElementById('retirement-error-message');
            retirementChartCtx = document.getElementById('retirementChart')?.getContext('2d');

            // Savings Goal Elements
            goalNameInput = document.getElementById('goalName');
            goalAmountInput = document.getElementById('goalAmount');
            goalYearsInput = document.getElementById('goalYears');
            goalInterestRateInput = document.getElementById('goalInterestRate');
            goalInterestRateValue = document.getElementById('goalInterestRateValue');
            goalYearsValue = document.getElementById('goalYearsValue');
            monthlySavingsGoalEl = document.getElementById('monthlySavingsGoal');
            savingsResultTitleEl = document.getElementById('savings-result-title');
            savingsErrorMessageEl = document.getElementById('savings-error-message');
            savingsChartCtx = document.getElementById('savingsChart')?.getContext('2d');
            savingsSummaryDiv = document.getElementById('savings-summary');
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            retirementTab.addEventListener('click', () => switchTab('retirement'));
            savingsTab.addEventListener('click', () => switchTab('savings'));
            
            currencySelectorDiv.addEventListener('click', (e) => {
                if(e.target.matches('.currency-button')) {
                    const newCurrency = e.target.dataset.currency;
                    if(newCurrency !== currentCurrency) updateCurrency(newCurrency);
                }
            });

            headerControlsDiv.addEventListener('click', (e) => {
                 const langBtn = e.target.closest('.lang-button');
                 if(langBtn) {
                    const newLang = langBtn.dataset.lang;
                    if(newLang !== currentLang) updateLanguage(newLang);
                 }
                 const themeBtn = e.target.closest('#theme-toggle');
                 if (themeBtn) {
                    toggleTheme();
                 }
            });

            [currentAgeInput, retirementAgeInput, interestRateInput, inflationRateInput].forEach(input => input.addEventListener('input', calculateRetirement));
            [initialSavingsInput, monthlyPensionInput].forEach(input => {
                input.addEventListener('input', () => { formatNumber(input); calculateRetirement(); });
            });

            [goalNameInput, goalAmountInput, goalYearsInput, goalInterestRateInput].forEach(input => {
                 input.addEventListener('input', () => {
                     if(input.id === 'goalAmount') formatNumber(input);
                     calculateSavingsGoal();
                 });
            });
        }
        
        // --- Theme Handling ---
        function toggleTheme() {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
            calculateRetirement();
            calculateSavingsGoal();
        }

        function setInitialTheme() {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                themeToggleLightIcon.classList.remove('hidden');
                document.documentElement.classList.add('dark');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
                 document.documentElement.classList.remove('dark');
            }
        }

        // --- Language Handling ---
        function updateLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            document.querySelectorAll('.lang-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
                btn.classList.toggle('inactive', btn.dataset.lang !== lang);
            });
            
            goalNameInput.placeholder = (lang === 'es') ? 'Ej: Pie para un auto' : 'E.g: Car down payment';

            calculateRetirement();
            calculateSavingsGoal();
        }

        // --- View Switching & Currency ---
        function switchTab(tab) {
            const isRetirement = tab === 'retirement';
            retirementTab.classList.toggle('active', isRetirement);
            retirementTab.classList.toggle('inactive', !isRetirement);
            savingsTab.classList.toggle('active', !isRetirement);
            savingsTab.classList.toggle('inactive', isRetirement);
            retirementCalculatorDiv.classList.toggle('hidden', !isRetirement);
            savingsCalculatorDiv.classList.toggle('hidden', isRetirement);
            
            if(isRetirement) calculateRetirement();
            else calculateSavingsGoal();
        }
        
        function updateCurrency(newCurrency) {
            currentCurrency = newCurrency;
            const settings = currencySettings[currentCurrency];
            
            document.querySelectorAll('.currency-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.currency === newCurrency);
                btn.classList.toggle('inactive', btn.dataset.currency !== newCurrency);
            });
            
            document.querySelectorAll('.currency-label, .currency-label-goal').forEach(label => label.textContent = currentCurrency);
            
            initialSavingsInput.value = settings.defaultInitial;
            monthlyPensionInput.value = settings.defaultPension;
            goalAmountInput.value = settings.defaultGoal;
            
            [initialSavingsInput, monthlyPensionInput, goalAmountInput].forEach(input => formatNumber(input));
            
            calculateRetirement();
            calculateSavingsGoal();
        }

        // --- Format & Calculation ---
        function formatNumber(input) {
            const settings = currencySettings[currentCurrency];
            let value = input.value.replace(/[^0-9]/g, '');
            input.value = value ? new Intl.NumberFormat(settings.locale).format(value) : '';
        }

        // --- RETIREMENT CALCULATOR ---
        function calculateRetirement() {
            retirementErrorMessageEl.textContent = '';
            const settings = currencySettings[currentCurrency];
            const T = translations[currentLang];

            const age = parseInt(currentAgeInput.value);
            const retirementAge = parseInt(retirementAgeInput.value);
            const interest = parseFloat(interestRateInput.value) / 100;
            const inflation = parseFloat(inflationRateInput.value) / 100;
            const initialSavings = parseFloat(initialSavingsInput.value.replace(/[^0-9]/g, '')) || 0;
            const monthlyPensionPresentValue = parseFloat(monthlyPensionInput.value.replace(/[^0-9]/g, '')) || 0;

            currentAgeValue.textContent = age;
            retirementAgeValue.textContent = retirementAge;
            interestRateValue.textContent = interestRateInput.value;
            inflationRateValue.textContent = inflationRateInput.value;

            if (retirementAge <= age || retirementAge >= LIFE_EXPECTANCY) {
                retirementErrorMessageEl.textContent = T.errorRetirementAge;
                if(retirementChart) retirementChart.destroy();
                return;
            }

            const yearsToSave = retirementAge - age;
            const realAnnualRate = interest - inflation;
            const monthlyPensionFutureValue = monthlyPensionPresentValue * Math.pow(1 + inflation, yearsToSave);
            
            const pensionYears = LIFE_EXPECTANCY - retirementAge;
            const pensionMonths = pensionYears * 12;
            const monthlyRealRate = realAnnualRate / 12;

            let totalFundNeeded = (monthlyRealRate !== 0)
                ? monthlyPensionFutureValue * ((1 - Math.pow(1 + monthlyRealRate, -pensionMonths)) / monthlyRealRate)
                : monthlyPensionFutureValue * pensionMonths;

            const futureValueOfInitialSavings = initialSavings * Math.pow(1 + realAnnualRate, yearsToSave);
            const targetFundFromContributions = totalFundNeeded - futureValueOfInitialSavings;
            
            let annualContribution = 0;
            if (targetFundFromContributions > 0) {
                annualContribution = (realAnnualRate !== 0)
                    ? (targetFundFromContributions * realAnnualRate) / (Math.pow(1 + realAnnualRate, yearsToSave) - 1)
                    : targetFundFromContributions / yearsToSave;
            }
           
            const monthlyContribution = annualContribution / 12;
            const formatter = new Intl.NumberFormat(settings.locale, { style: 'currency', currency: currentCurrency, minimumFractionDigits: 0, maximumFractionDigits: 0 });
            
            monthlySavingEl.textContent = formatter.format(monthlyContribution);
            annualSavingEl.textContent = formatter.format(annualContribution);
            
            const totalContributions = initialSavings + (annualContribution * yearsToSave);
            const totalInterest = totalFundNeeded - totalContributions;

            retirementSummaryDiv.innerHTML = `
                <p class="text-gray-700 dark:text-gray-300">${T.retirementSummary1} <span class="font-bold">${LIFE_EXPECTANCY} ${T.chartYear.toLowerCase()}s</span>, ${T.retirementSummary2} <span class="font-bold">${formatter.format(totalFundNeeded)}</span>.</p>
                <p class="text-gray-700 dark:text-gray-300 mt-2">${T.retirementSummary3} <span class="font-bold">${formatter.format(totalContributions)}</span> ${T.retirementSummary4} <span class="font-bold">${formatter.format(totalInterest)}</span> ${T.retirementSummary5}.</p>
            `;
            pensionFutureValueNoteEl.textContent = `${T.pensionFutureNote} ${formatter.format(monthlyPensionFutureValue)} ${T.pensionFutureNote2}`;
            
            updateRetirementChart(yearsToSave, initialSavings, annualContribution, realAnnualRate, settings);
        }

        function updateRetirementChart(years, initial, annual, rate, settings) {
            if (retirementChart) retirementChart.destroy();
            const T = translations[currentLang];
            const labels = []; const principalData = []; const interestData = [];
            const totalMonths = years * 12;
            const monthlyRate = rate / 12;
            const monthlyContribution = annual / 12;
            let balance = initial;
            
            for (let m = 1; m <= totalMonths; m++) {
                balance = balance * (1 + monthlyRate) + monthlyContribution;
                if (m % 12 === 0 || m === totalMonths) { 
                    const year = Math.ceil(m / 12);
                    labels.push(`${T.chartYear} ${year}`);
                    const yearPrincipal = initial + (monthlyContribution * m);
                    const yearInterest = balance - yearPrincipal;
                    principalData.push(yearPrincipal);
                    interestData.push(yearInterest);
                }
            }
            
            retirementChart = new Chart(retirementChartCtx, {
                type: 'bar',
                data: { labels, datasets: [{ label: T.chartTotalContributions, data: principalData, backgroundColor: '#818cf8' }, { label: T.chartInterestEarned, data: interestData, backgroundColor: '#c7d2fe' }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: `${T.chartValue} (${currentCurrency})` } } },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat(settings.locale, { style: 'currency', currency: currentCurrency, maximumFractionDigits:0 }).format(context.parsed.y)}` } } }
                }
            });
        }

        // --- SAVINGS GOAL CALCULATOR ---
        function calculateSavingsGoal() {
            savingsErrorMessageEl.textContent = '';
            const settings = currencySettings[currentCurrency];
            const T = translations[currentLang];
            
            const goalName = goalNameInput.value || T.yourSavingsGoal;
            const goalAmount = parseFloat(goalAmountInput.value.replace(/[^0-9]/g, '')) || 0;
            const years = parseInt(goalYearsInput.value);
            const annualInterestRate = parseFloat(goalInterestRateInput.value) / 100;

            goalYearsValue.textContent = years;
            goalInterestRateValue.textContent = goalInterestRateInput.value;
            savingsResultTitleEl.textContent = `${T.savingsPlanFor} "${goalName}"`;
            
            if (goalAmount <= 0) {
                savingsErrorMessageEl.textContent = T.errorGoalAmount;
                 if(savingsChart) savingsChart.destroy();
                return;
            }

            const totalMonths = years * 12;
            const monthlyRate = annualInterestRate / 12;
            let monthlySavings = (monthlyRate > 0)
                ? goalAmount * (monthlyRate / (Math.pow(1 + monthlyRate, totalMonths) - 1))
                : goalAmount / totalMonths;

            const formatter = new Intl.NumberFormat(settings.locale, { style: 'currency', currency: currentCurrency, minimumFractionDigits: 0, maximumFractionDigits: 0 });
            monthlySavingsGoalEl.textContent = formatter.format(monthlySavings);
            
            const totalContributions = monthlySavings * totalMonths;
            const totalInterest = goalAmount - totalContributions;

            savingsSummaryDiv.innerHTML = `
                <p class="text-gray-700 dark:text-gray-300">${T.savingsSummary1} <span class="font-bold">${formatter.format(totalContributions)}</span> ${T.savingsSummary2} <span class="font-bold">${formatter.format(totalInterest)}</span> ${T.savingsSummary3} <span class="font-bold">${formatter.format(goalAmount)}</span>.</p>
            `;

            updateSavingsChart(years, monthlySavings, annualInterestRate, settings);
        }
        
        function updateSavingsChart(years, monthlySavings, rate, settings) {
            if (savingsChart) savingsChart.destroy();
            const T = translations[currentLang];
            const labels = []; const principalData = []; const interestData = [];
            const totalMonths = years * 12;
            const monthlyRate = rate / 12;
            let balance = 0;

            for (let m = 1; m <= totalMonths; m++) {
                 balance = balance * (1 + monthlyRate) + monthlySavings;
                if (m % 12 === 0 || m === totalMonths) {
                    const year = Math.ceil(m / 12);
                    labels.push(`${T.chartYear} ${year}`);
                    const yearPrincipal = monthlySavings * m;
                    const yearInterest = balance - yearPrincipal;
                    principalData.push(yearPrincipal);
                    interestData.push(yearInterest);
                }
            }

            savingsChart = new Chart(savingsChartCtx, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: [ { label: T.chartTotalContributions, data: principalData, backgroundColor: '#818cf8' }, { label: T.chartInterestEarned, data: interestData, backgroundColor: '#c7d2fe' } ] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {  x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: `${T.chartValue} (${currentCurrency})` } }  },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat(settings.locale, { style: 'currency', currency: currentCurrency, maximumFractionDigits:0 }).format(context.parsed.y)}` } } }
                }
            });
        }
        
        window.onload = () => {
            assignDOMElements();
            setInitialTheme();
            setupEventListeners();
            updateCurrency('CLP');
            updateLanguage('es');
        };
    </script>
</body>
</html>
